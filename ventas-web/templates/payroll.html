{% extends "layout.html" %}
{% block content %}

<div class="flex-between mb-16">
  <div>
    <h1 class="page-title">AnÃ¡lisis de NÃ³minas</h1>
    <p class="page-subtitle">DetecciÃ³n de anomalÃ­as y clustering de empleados</p>
  </div>
  <a href="/admin" class="back-link">â† Volver a AdministraciÃ³n</a>
</div>

<!-- KPI Cards -->
<div class="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-label">ğŸ‘¥ Total de Filas</div>
    <div class="kpi-value">{{ total_rows }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">âš ï¸ AnomalÃ­as (Total)</div>
    <div class="kpi-value" style="color: #dc2626;">{{ total_anoms }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">ğŸ“Š Filas (Filtro Actual)</div>
    <div class="kpi-value">{{ filtered_rows }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">âš ï¸ AnomalÃ­as (Filtro)</div>
    <div class="kpi-value" style="color: #dc2626;">{{ filtered_anoms }}</div>
  </div>
</div>

<!-- Filtros -->
<form method="get" action="/payroll">
  <div class="form-title">ğŸ” Filtros de BÃºsqueda</div>
  <div class="form-row">
    <div class="form-group">
      <label for="role">Rol</label>
      <select id="role" name="role">
        <option value="">(Todos)</option>
        {% for r in roles %}
          <option value="{{ r }}" {% if selected_role == r %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="location">UbicaciÃ³n</label>
      <select id="location" name="location">
        <option value="">(Todas)</option>
        {% for l in locations %}
          <option value="{{ l }}" {% if selected_location == l %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="employee_id">ID de Empleado</label>
      <input id="employee_id" type="text" name="employee_id" value="{{ selected_employee_id }}" placeholder="1001..." />
    </div>

    <div class="form-group">
      <label for="cluster">Cluster</label>
      <select id="cluster" name="cluster">
        <option value="">(Todos)</option>
        {% for c in clusters_list %}
          <option value="{{ c }}" {% if selected_cluster|string == c|string %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label class="checkbox-label">
        <input type="checkbox" name="anomaly_only" value="1" {% if selected_anomaly_only %}checked{% endif %}>
        Solo anomalÃ­as
      </label>
    </div>

    <div class="form-group" style="align-self: flex-end;">
      <button type="submit">ğŸ” Aplicar Filtros</button>
    </div>

    <div class="form-group" style="align-self: flex-end;">
      <a href="/payroll" class="btn btn-secondary">â†º Limpiar</a>
    </div>
  </div>
</form>

<!-- GrÃ¡ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px; margin-top: 28px;">
  <div class="chart-container">
    <h3 class="chart-title">ğŸ“Š AnomalÃ­as por Rol (Top 10)</h3>
    <canvas id="barRoles" height="100"></canvas>
  </div>

  <div class="chart-container">
    <h3 class="chart-title">ğŸ“ˆ AnomalÃ­as por Mes</h3>
    <p class="chart-subtitle">SegÃºn filtro actual</p>
    <canvas id="lineMonths" height="100"></canvas>
  </div>
</div>

<div class="chart-container" style="margin-top: 24px;">
  <h3 class="chart-title">ğŸ“ Scatter: Horas vs Salario Bruto</h3>
  <p class="chart-subtitle">Puntos rojos indican anomalÃ­as detectadas</p>
  <canvas id="scatterHG" height="120"></canvas>
</div>

<script>
  const roleData = {{ role_anom_counts | tojson }};
  const monthData = {{ anoms_by_month | tojson }};
  const scatterData = {{ scatter | tojson }};

  // Barras roles
  const roles = roleData.map(d => d.role);
  const roleAnoms = roleData.map(d => d.anoms);

  new Chart(document.getElementById("barRoles"), {
    type: "bar",
    data: {
      labels: roles,
      datasets: [{
        label: "AnomalÃ­as",
        data: roleAnoms,
        backgroundColor: '#dc2626',
        borderColor: '#991b1b',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        x: {
          ticks: {
            autoSkip: false,
            font: {size: 10}
          },
          grid: {
            color: 'rgba(226, 232, 240, 0.5)'
          }
        },
        y: {
          grid: {
            color: 'rgba(226, 232, 240, 0.5)'
          }
        }
      }
    }
  });

  // LÃ­nea meses
  const months = monthData.map(d => d.month);
  const monthAnoms = monthData.map(d => d.anoms);

  new Chart(document.getElementById("lineMonths"), {
    type: "line",
    data: {
      labels: months,
      datasets: [{
        label: "AnomalÃ­as",
        data: monthAnoms,
        tension: 0.4,
        borderColor: '#dc2626',
        backgroundColor: 'rgba(220, 38, 38, 0.1)',
        borderWidth: 3,
        fill: true,
        pointRadius: 4,
        pointBackgroundColor: '#dc2626'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        x: {
          grid: {
            color: 'rgba(226, 232, 240, 0.5)'
          }
        },
        y: {
          grid: {
            color: 'rgba(226, 232, 240, 0.5)'
          }
        }
      }
    }
  });

  // Scatter hours vs gross (separamos normal/anom para que se vea mejor)
  const normalPts = scatterData.filter(p => p.anomaly === 1).map(p => ({x: p.x, y: p.y}));
  const anomPts = scatterData.filter(p => p.anomaly === -1).map(p => ({x: p.x, y: p.y}));

  new Chart(document.getElementById("scatterHG"), {
    type: "scatter",
    data: {
      datasets: [
        {
          label: "Normal",
          data: normalPts,
          pointRadius: 3,
          pointBackgroundColor: '#2563eb',
          pointBorderColor: '#1e40af',
          pointBorderWidth: 1
        },
        {
          label: "AnomalÃ­a",
          data: anomPts,
          pointRadius: 5,
          pointBackgroundColor: '#dc2626',
          pointBorderColor: '#991b1b',
          pointBorderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: "Horas Quincenales",
            font: {weight: 'bold'}
          },
          grid: {
            color: 'rgba(226, 232, 240, 0.5)'
          }
        },
        y: {
          title: {
            display: true,
            text: "Salario Bruto",
            font: {weight: 'bold'}
          },
          grid: {
            color: 'rgba(226, 232, 240, 0.5)'
          }
        }
      }
    }
  });
</script>

<hr>

<!-- Tabla de AnomalÃ­as -->
<div class="section-header">
  <h2 class="section-title">âš ï¸ AnomalÃ­as Detectadas</h2>
  <p class="section-subtitle">MÃ¡ximo 20 registros (mÃ¡ximo 20 filas por pÃ¡gina)</p>
</div>

{% if anomalies and anomalies|length > 0 %}
  <div style="overflow-x: auto;">
    <table>
      <thead>
        <tr>
          <th>ğŸ“… PerÃ­odo</th>
          <th>ğŸ‘¤ ID Empleado</th>
          <th>ğŸ‘¤ Nombre</th>
          <th>ğŸ“ UbicaciÃ³n</th>
          <th>ğŸ’¼ Rol</th>
          <th>â° Horas</th>
          <th>ğŸ’µ Salario Bruto</th>
          <th>ğŸ Beneficios</th>
          <th>ğŸ’° Salario Neto</th>
        </tr>
      </thead>
      <tbody>
        {% for r in anomalies %}
        <tr>
          <td><strong>{{ r.pay_period_start }}</strong></td>
          <td>{{ r.employee_id }}</td>
          <td>{{ r.employee_name }}</td>
          <td>{{ r.location }}</td>
          <td>{{ r.role }}</td>
          <td>{{ r.hours_biweekly }}</td>
          <td style="color: #dc2626; font-weight: 600;">{{ "%.2f"|format(r.gross_pay) }}</td>
          <td>{{ "%.2f"|format(r.employee_benefits) }}</td>
          <td><strong>{{ "%.2f"|format(r.net_pay) }}</strong></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div style="padding: 32px; text-align: center; background: var(--bg-secondary); border-radius: 12px;">
    <p style="color: var(--text-secondary); margin: 0; font-size: 1rem;">âœ“ No hay anomalÃ­as para el filtro actual</p>
  </div>
{% endif %}

<hr>

<!-- Tabla de Clusters -->
<div class="section-header">
  <h2 class="section-title">ğŸ¯ Clustering de Empleados</h2>
  <p class="section-subtitle">AgrupaciÃ³n de empleados por patrones de nÃ³mina (mÃ¡ximo 20 filas)</p>
</div>

{% if clusters and clusters|length > 0 %}
  <div style="overflow-x: auto;">
    <table>
      <thead>
        <tr>
          <th>ğŸ‘¤ ID Empleado</th>
          <th>ğŸ’¼ Rol</th>
          <th>â° Horas Quincenales</th>
          <th>ğŸ’µ Salario Bruto</th>
          <th>ğŸ Beneficios</th>
          <th>ğŸ’° Salario Neto</th>
          <th>ğŸ¯ Cluster</th>
        </tr>
      </thead>
      <tbody>
        {% for r in clusters %}
        <tr>
          <td><strong>{{ r.employee_id }}</strong></td>
          <td>{{ r.role }}</td>
          <td>{{ r.hours_biweekly }}</td>
          <td>{{ "%.2f"|format(r.gross_pay) }}</td>
          <td>{{ "%.2f"|format(r.employee_benefits) }}</td>
          <td>{{ "%.2f"|format(r.net_pay) }}</td>
          <td>
            <span style="display: inline-block; padding: 6px 12px; background: var(--primary-light); color: var(--primary); border-radius: 6px; font-weight: 600; font-size: 0.85rem;">
              Cluster {{ r.cluster }}
            </span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div style="padding: 32px; text-align: center; background: var(--bg-secondary); border-radius: 12px;">
    <p style="color: var(--text-secondary); margin: 0; font-size: 1rem;">No hay clusters para el filtro actual</p>
  </div>
{% endif %}

{% endblock %}
