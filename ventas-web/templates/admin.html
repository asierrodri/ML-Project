{% extends "layout.html" %}
{% block content %}

<div class="section-header">
  <h1 class="page-title">AdministraciÃ³n del Sistema</h1>
  <p class="page-subtitle">Gestiona los datos y modelos de Machine Learning</p>
</div>

<!-- Estado del sistema -->
<div class="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-label">ğŸ“Š Datos RAW</div>
    <div class="kpi-value">{{ info.raw_exists }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">ğŸ“ˆ Filas Agregadas</div>
    <div class="kpi-value">{{ info.monthly_rows }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">ğŸ¤– Modelo Guardado</div>
    <div class="kpi-value">{{ info.model_exists }}</div>
  </div>
</div>

<!-- MÃ©tricas del modelo -->
{% if info.metrics %}
  <div class="chart-container">
    <h3 class="chart-title">ğŸ“Š MÃ©tricas del Modelo (ValidaciÃ³n Temporal)</h3>
    <ul class="info-list">
      {% if info.metrics.training_mode %}
        <li>
          <span class="info-label">Modo de Entrenamiento</span>
          <span class="info-value">{{ info.metrics.training_mode }}</span>
        </li>
      {% endif %}
      {% if info.metrics.min_date is not none %}
        <li>
          <span class="info-label">Filtro de Fecha</span>
          <span class="info-value">Desde {{ info.metrics.min_date }}</span>
        </li>
      {% else %}
        <li>
          <span class="info-label">Filtro de Fecha</span>
          <span class="info-value">Sin filtro (incluye pre-2020)</span>
        </li>
      {% endif %}
      <li>
        <span class="info-label">Meses de Prueba</span>
        <span class="info-value">{{ info.metrics.test_months }}</span>
      </li>
      <li>
        <span class="info-label">MAE (Test)</span>
        <span class="info-value" style="color: #2563eb;">{{ info.metrics.mae_test | round(2) }}</span>
      </li>
      <li>
        <span class="info-label">RMSE (Test)</span>
        <span class="info-value" style="color: #2563eb;">{{ info.metrics.rmse_test | round(2) }}</span>
      </li>
    </ul>
  </div>
{% endif %}

<hr>

<!-- SecciÃ³n 1: GestiÃ³n de Datos -->
<div class="section-header">
  <h2 class="section-title">ğŸ“ Paso 1: GestiÃ³n de Datos</h2>
  <p class="section-subtitle">Carga y procesa tus archivos CSV</p>
</div>

<form method="post" action="/admin/upload" enctype="multipart/form-data">
  <div class="form-title">Subir Datos de Ventas (CSV)</div>
  <div class="form-row">
    <div class="form-group" style="grid-column: 1 / -1;">
      <label for="file">Selecciona un archivo CSV</label>
      <input id="file" type="file" name="file" accept=".csv" required />
      <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">
        El archivo serÃ¡ procesado y agregado mensualmente para el entrenamiento del modelo.
      </p>
    </div>
    <div class="form-group" style="grid-column: 1 / -1;">
      <button type="submit">ğŸ“¤ Subir y Recalcular Datos Mensuales</button>
    </div>
  </div>
</form>

<hr>

<!-- SecciÃ³n 2: Entrenamiento del Modelo -->
<div class="section-header">
  <h2 class="section-title">ğŸ¤– Paso 2: Entrenamiento del Modelo</h2>
  <p class="section-subtitle">Entrena el modelo de predicciÃ³n de ventas</p>
</div>

<form method="post" action="/admin/retrain">
  <div class="form-title">Reentrenar Modelo de Ventas</div>

  <div class="form-row" style="grid-template-columns: 1fr;">
    <div class="form-group">
      <label class="checkbox-label">
        <input type="checkbox" name="include_pre_2020" value="1">
        Incluir datos anteriores a 2020 (modo crisis)
      </label>
      <span class="checkbox-help">
        Por defecto se entrena solo con datos desde 2020 para seguir la tendencia "normal". Activa esta opciÃ³n si deseas incluir datos histÃ³ricos de periodos de crisis.
      </span>
    </div>

    <div class="form-group" style="margin-top: 16px;">
      <button type="submit">ğŸ”„ Reentrenar y Guardar Modelo</button>
    </div>
  </div>
</form>

<hr>

<!-- SecciÃ³n 3: GestiÃ³n de NÃ³minas -->
<div class="section-header">
  <h2 class="section-title">ğŸ’¼ GestiÃ³n de NÃ³minas (Payroll)</h2>
  <p class="section-subtitle">AnÃ¡lisis de anomalÃ­as en datos de nÃ³mina</p>
</div>

<!-- Estado Payroll -->
<div class="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-label">ğŸ“Š Payroll RAW</div>
    <div class="kpi-value">{{ info.payroll_raw_exists }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">ğŸ“ˆ NormalizaciÃ³n ISO</div>
    <div class="kpi-value">{{ info.payroll_iso_exists }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">ğŸ¯ KMeans</div>
    <div class="kpi-value">{{ info.payroll_kmeans_exists }}</div>
  </div>
</div>

<!-- MÃ©tricas Payroll -->
{% if info.payroll_metrics %}
  <div class="chart-container">
    <h3 class="chart-title">ğŸ“Š MÃ©tricas de NÃ³mina</h3>
    <ul class="info-list">
      <li>
        <span class="info-label">Features Utilizadas</span>
        <span class="info-value">{{ info.payroll_metrics.features }}</span>
      </li>
      <li>
        <span class="info-label">Roles Modelados</span>
        <span class="info-value">{{ info.payroll_metrics.roles_modeled }} / {{ info.payroll_metrics.roles_total }}</span>
      </li>
      <li>
        <span class="info-label">NÃºmero de Clusters</span>
        <span class="info-value">{{ info.payroll_metrics.n_clusters }}</span>
      </li>
      <li>
        <span class="info-label">Total de Filas</span>
        <span class="info-value">{{ info.payroll_metrics.rows_payroll }}</span>
      </li>
    </ul>
  </div>
{% endif %}

<div class="section-header mt-16">
  <h3 class="section-title">ğŸ“ Paso 1: Cargar Datos de NÃ³mina</h3>
</div>

<form method="post" action="/admin/payroll/upload" enctype="multipart/form-data">
  <div class="form-title">Subir Datos de NÃ³mina (CSV)</div>
  <div class="form-row">
    <div class="form-group" style="grid-column: 1 / -1;">
      <label for="payroll-file">Selecciona un archivo CSV de nÃ³mina</label>
      <input id="payroll-file" type="file" name="file" accept=".csv" required />
      <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">
        Carga los datos de nÃ³mina para anÃ¡lisis de anomalÃ­as y clustering.
      </p>
    </div>
    <div class="form-group" style="grid-column: 1 / -1;">
      <button type="submit">ğŸ“¤ Subir Datos de NÃ³mina</button>
    </div>
  </div>
</form>

<div class="section-header mt-16">
  <h3 class="section-title">ğŸ¤– Paso 2: Entrenar Modelos de NÃ³mina</h3>
</div>

<form method="post" action="/admin/payroll/retrain">
  <div class="form-title">Entrenar Modelos de DetecciÃ³n de AnomalÃ­as</div>
  <div class="form-row">
    <div class="form-group" style="grid-column: 1 / -1;">
      <p style="font-size: 0.95rem; color: var(--text-secondary); margin: 0 0 16px 0;">
        Se entrenarÃ¡n los modelos de normalizaciÃ³n ISO y clustering KMeans para detectar anomalÃ­as en los datos de nÃ³mina.
      </p>
      <button type="submit">ğŸ”„ Entrenar y Guardar Modelos de NÃ³mina</button>
    </div>
  </div>
</form>

<div class="flex-between mt-16" style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
  <span style="font-weight: 500;">Ver anÃ¡lisis de nÃ³mina</span>
  <a href="/payroll" class="btn btn-secondary btn-small">Ir a Payroll â†’</a>
</div>

{% endblock %}
